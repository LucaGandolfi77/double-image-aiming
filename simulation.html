<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulazione Double Image Aiming - Top Down</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        header {
            width: 100%;
            padding: 10px 20px;
            background-color: #1e1e1e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
        }

        h1 { margin: 0; font-size: 1.2rem; color: #4caf50; }

        #main-container {
            display: flex;
            flex: 1;
            width: 100%;
            overflow: hidden;
        }

        #canvas-container {
            flex: 3;
            position: relative;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-right: 1px solid #333;
            overflow: hidden;
        }

        canvas {
            background: #0d1117; 
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.05);
            cursor: crosshair;
        }

        #sidebar {
            flex: 1;
            padding: 20px;
            background-color: #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 250px;
            max-width: 350px;
            border-left: 1px solid #333;
        }

        .panel {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .panel h2 {
            margin-top: 0;
            font-size: 0.9rem;
            color: #888;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .data-label { color: #aaa; }
        .data-value { font-weight: bold; }
        .val-green { color: #4caf50; }
        .val-cyan { color: #00bcd4; }
        .val-yellow { color: #ffeb3b; }

        #controls-bar {
            width: 100%;
            background-color: #1e1e1e;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-top: 1px solid #333;
            z-index: 10;
        }

        button {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover { background: #444; border-color: #777; }
        button:active { background: #555; }
        button.active { background: #4caf50; border-color: #4caf50; color: #000; }

        input[type=range] {
            flex: 1;
            accent-color: #4caf50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .icon-tri { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid lime; display: inline-block; }

        /* Artificial Horizon css representation */
        #horizon-container {
            width: 100px;
            height: 100px;
            background: linear-gradient(to bottom, #00BCD4 50%, #795548 50%);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            border: 2px solid #555;
        }
        #horizon-line {
            width: 100%;
            height: 2px;
            background: white;
            position: absolute;
            top: 50%;
            transform-origin: center;
        }

        /* --- DEBUG CONSOLE STYLES --- */
        #debug-console {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 380px;
            max-height: 250px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #555;
            color: #ccc;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border-radius: 4px;
            backdrop-filter: blur(5px);
        }

        #debug-header {
            background: #2d2d2d;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
            font-weight: bold;
            color: #fff;
            font-size: 12px;
        }

        #debug-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-info { color: #88ff88; }
        .log-warn { color: #ffff88; }
        .log-error { color: #ff8888; font-weight: bold; }
        .log-time { color: #666; margin-right: 8px; font-size: 10px; }

        #btn-clear-debug {
            background: #444;
            border: none;
            color: white;
            padding: 2px 8px;
            font-size: 10px;
            cursor: pointer;
            border-radius: 2px;
        }
        #btn-clear-debug:hover { background: #666; }

        /* Scrollbar styles for debug */
        #debug-content::-webkit-scrollbar { width: 8px; }
        #debug-content::-webkit-scrollbar-track { background: #111; }
        #debug-content::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <h1>TOP-DOWN AIMING VISUALIZATION</h1>
    <div style="font-size: 0.8rem; color: #888;">Simulazione v2.1 (Debug Mode)</div>
</header>

<!-- Debug Console Overlay -->
<div id="debug-console">
    <div id="debug-header">
        <span>üîß SYSTEM DIAGNOSTICS</span>
        <button id="btn-clear-debug">Clear</button>
    </div>
    <div id="debug-content"></div>
</div>

<div id="main-container">
    <div id="canvas-container">
        <canvas id="simCanvas" width="640" height="480"></canvas>
    </div>

    <div id="sidebar">
        <div class="panel">
            <h2>STATO SISTEMA</h2>
            <div class="data-row"><span class="data-label">Tempo:</span> <span id="val-time" class="data-value">0.00s</span></div>
            <div class="data-row"><span class="data-label">Stato:</span> <span id="val-status" class="data-value val-green">INIT</span></div>
        </div>

        <div class="panel">
            <h2>TELEMETRIA</h2>
            <div class="data-row"><span class="data-label">Distanza:</span> <span id="val-dist" class="data-value">--</span></div>
            <div class="data-row"><span class="data-label">Velocit√†:</span> <span id="val-vel" class="data-value">--</span></div>
            <div class="data-row"><span class="data-label">Yaw:</span> <span id="val-yaw" class="data-value">--</span></div>
            <div class="data-row"><span class="data-label">Pitch:</span> <span id="val-pitch" class="data-value">--</span></div>
        </div>
        
        <div class="panel" style="text-align: center;">
            <h2>ORIENTAMENTO</h2>
            <div id="horizon-container">
                <div id="horizon-line"></div>
            </div>
        </div>

        <div class="panel">
            <h2>LEGENDA (TOP-DOWN)</h2>
            <div class="legend-item"><span class="icon-tri"></span> Posizione Rilevata</div>
            <div class="legend-item"><span class="dot" style="background: cyan; border: 1px solid white;"></span> Posizione Predetta</div>
            <div class="legend-item"><span class="dot" style="background: #888;"></span> Sensore/Camera</div>
            <div class="legend-item"><span style="color: lime;">-----</span> Traiettoria Reale</div>
            <div class="legend-item"><span style="color: cyan;">-----</span> Traiettoria Predetta</div>
        </div>
    </div>
</div>

<div id="controls-bar">
    <input type="file" id="file-picker" accept=".csv" title="Select local CSV">
    <select id="csv-list" style="min-width:180px">
        <option value="">-- select CSV --</option>
    </select>
    <button id="btn-load-selected">üìÇ Load Selected</button>
    <div style="width: 1px; height: 20px; background: #444; margin: 0 10px;"></div>

    <button id="btn-play">‚ñ∂ Play</button>
    <button id="btn-pause" style="display:none;">‚è∏ Pause</button>
    <button id="btn-prev">‚èÆ Frame</button>
    <button id="btn-next">Frame ‚è≠</button>
    
    <span style="font-size: 0.9rem; margin-left:10px;">Timeline:</span>
    <input type="range" id="timeline" min="0" max="100" value="0" step="1">
    
    <span style="font-size: 0.9rem; margin-left:10px;">Zoom:</span>
    <button id="btn-zoom-out">-</button>
    <span id="zoom-level">100%</span>
    <button id="btn-zoom-in">+</button>
</div>

<script>
    // --- DEBUG SYSTEM ---
    const debugContent = document.getElementById('debug-content');
    
    function log(msg, type='info') {
        const now = new Date();
        const timeStr = now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');
        
        const div = document.createElement('div');
        div.className = `log-entry log-${type}`;
        div.innerHTML = `<span class="log-time">[${timeStr}]</span> ${msg}`;
        
        debugContent.appendChild(div);
        debugContent.scrollTop = debugContent.scrollHeight;
        
        // Also log to browser console
        if (type === 'error') console.error(msg);
        else if (type === 'warn') console.warn(msg);
        else console.log(msg);
    }

    document.getElementById('btn-clear-debug').addEventListener('click', () => {
        debugContent.innerHTML = '';
        log("Console cleared.");
    });

    // Capture Global Errors
    window.onerror = function(msg, url, line, col, error) {
        log(`Uncaught Error: ${msg} <br>Location: ${url}:${line}:${col}`, 'error');
        return false;
    };

    // --- PARSING ---
    function parseCSV(csv) {
        try {
            const lines = csv.trim().split(/\r?\n/);
            if (lines.length < 2) throw new Error("CSV file too short or empty");

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = lines[i].split(',');
                if (values.length !== headers.length) {
                    log(`Skipping malformed line ${i+1}: expected ${headers.length} columns, got ${values.length}`, 'warn');
                    continue;
                }
                
                const entry = {};
                headers.forEach((h, index) => {
                    entry[h] = parseFloat(values[index]);
                });
                data.push(entry);
            }
            return data;
        } catch (e) {
            log("CSV Parse Error: " + e.message, 'error');
            return [];
        }
    }

    // --- STATE ---
    let flightData = [];
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const width = 640;
    const height = 480;
    
    // UI Elements
    const timeline = document.getElementById('timeline');
    const timeDisplay = document.getElementById('val-time');
    const statusDisplay = document.getElementById('val-status');
    const distDisplay = document.getElementById('val-dist');
    const velDisplay = document.getElementById('val-vel');
    const yawDisplay = document.getElementById('val-yaw');
    const pitchDisplay = document.getElementById('val-pitch');
    const zoomDisplay = document.getElementById('zoom-level');
    const horizonLine = document.getElementById('horizon-line');

    const btnPlay = document.getElementById('btn-play');
    const btnPause = document.getElementById('btn-pause');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const filePicker = document.getElementById('file-picker');
    const csvList = document.getElementById('csv-list');
    const btnLoadSelected = document.getElementById('btn-load-selected');

    let currentIndex = 0;
    let isPlaying = false;
    let playInterval = null;
    let zoom = 1.0;
    const playbackSpeedMS = 50; 

    // CONSTANTS FOR TOP-DOWN VIEW
    const FOCAL_LENGTH = 800;
    const CENTER_X = 320;
    const SCALE = 5.0; // Pixels per meter
    const OBSERVER_Y_OFFSET = 50; 

    // --- DATA LOADING ---
    function loadCsvFromUrl(url) {
        log(`Attempting to fetch '${url}'...`);
        return fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                log(`File fetched (Size: ${response.headers.get('content-length')} bytes type: ${response.headers.get('content-type')})`);
                return response.text();
            })
            .then(text => {
                const parsed = parseCSV(text);
                if (parsed.length > 0) {
                    flightData = parsed;
                    timeline.max = flightData.length - 1;
                    statusDisplay.textContent = "READY";
                    statusDisplay.className = "data-value val-green";
                    log(`Data Loaded Successfully. ${flightData.length} frames ready.`);
                    updateFrame(0);
                } else {
                    statusDisplay.textContent = "NO DATA";
                    statusDisplay.className = "data-value val-yellow";
                    log("Parsed data is empty.", 'warn');
                }
            })
            .catch(error => {
                log("FETCH FAILURE: " + error.message, 'error');
                log("‚ö†Ô∏è IMPORTANT: If you see a CORS error, you must serve this file via a web server.", 'warn');
                log("Try running: <code>python3 -m http.server</code> in the terminal and open localhost:8000/simulation.html", 'info');
                statusDisplay.textContent = "ERROR";
                statusDisplay.className = "data-value val-error";
            });
    }

    function loadCsvFromFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const parsed = parseCSV(text);
                if (parsed.length > 0) {
                    flightData = parsed;
                    timeline.max = flightData.length - 1;
                    statusDisplay.textContent = "READY";
                    statusDisplay.className = "data-value val-green";
                    log(`Local file loaded: ${file.name} (${file.size} bytes)`);
                    updateFrame(0);
                } else {
                    statusDisplay.textContent = "NO DATA";
                    statusDisplay.className = "data-value val-yellow";
                    log("Parsed data is empty from local file.", 'warn');
                }
            } catch (err) {
                log('File read/parse error: ' + err.message, 'error');
            }
        };
        reader.onerror = (e) => log('FileReader error: ' + e, 'error');
        reader.readAsText(file);
    }

    function populateCsvList() {
        // Try to fetch directory index and parse CSV links (works with SimpleHTTPServer index)
        fetch('./')
            .then(r => r.text())
            .then(html => {
                const regex = /href="([^"]+\.csv)"/ig;
                const files = new Set();
                let m;
                while ((m = regex.exec(html)) !== null) {
                    files.add(m[1]);
                }
                // add known local fallback
                files.add('flight_data.csv');
                files.add('flight_data_02.csv');

                csvList.innerHTML = '<option value="">-- select CSV --</option>';
                files.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f;
                    opt.textContent = f;
                    csvList.appendChild(opt);
                });
                log('CSV list populated from server index.');
            })
            .catch(err => {
                log('Could not populate server CSV list: ' + err.message, 'warn');
                // still keep defaults
                csvList.innerHTML = '<option value="">-- select CSV --</option>';
                ['flight_data.csv','flight_data_02.csv'].forEach(f => {
                    const opt = document.createElement('option'); opt.value = f; opt.textContent = f; csvList.appendChild(opt);
                });
            });
    }

    function loadSelectedCsv() {
        const sel = csvList.value;
        if (!sel) { log('No CSV selected.', 'warn'); return; }
        loadCsvFromUrl(sel);
    }

    filePicker.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) loadCsvFromFile(f);
    });

    btnLoadSelected.addEventListener('click', loadSelectedCsv);

    // populate CSV dropdown at startup
    populateCsvList();

    // --- DRAW LOGIC ---
    function projectTopDown(dist, yawDeg) {
        const yawRad = yawDeg * (Math.PI / 180);
        const worldX = Math.sin(yawRad) * dist;
        const worldY = Math.cos(yawRad) * dist;

        return {
            x: (width / 2) + (worldX * SCALE),
            y: (height - OBSERVER_Y_OFFSET) - (worldY * SCALE)
        };
    }

    function estimatePredTopDown(frame) {
         if (frame.PredX === undefined) return {x:0, y:0};
         const yawRad = Math.atan((frame.PredX - CENTER_X) / FOCAL_LENGTH);
         const yawDeg = yawRad * (180 / Math.PI);
         
         const dt = 0.051; 
         // Ensure we don't predict negative distance
         const predDist = Math.max(0, frame.Dist + (frame.Vel * dt));
         
         return projectTopDown(predDist, yawDeg);
    }

    function draw() {
        // Clear
        ctx.setTransform(1, 0, 0, 1, 0, 0); 
        ctx.fillStyle = "#0d1117"; 
        ctx.fillRect(0, 0, width, height);
        
        if (flightData.length === 0) {
            ctx.fillStyle = "#444";
            ctx.font = "14px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("NO DATA LOADED", width/2, height/2);
            ctx.fillText("Check Debug Console", width/2, height/2 + 20);
            return;
        }

        ctx.setTransform(zoom, 0, 0, zoom, (width - width * zoom) / 2, (height - height * zoom) / 2);

        drawRadarGrid();
        
        const frame = flightData[currentIndex];

        // FOV
        drawFOVCone();

        // Trails
        if (currentIndex > 0) {
            drawPath(currentIndex, 'Raw', "#4caf50", 2); 
            drawPath(currentIndex, 'Pred', "#00bcd4", 2, true); 
        }

        // Object
        if (frame.Found) {
            const rawPos = projectTopDown(frame.Dist, frame.Yaw);
            const predPos = estimatePredTopDown(frame);

            // Connect
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 0, 0.4)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.moveTo(rawPos.x, rawPos.y);
            ctx.lineTo(predPos.x, predPos.y);
            ctx.stroke();
            ctx.setLineDash([]);

            drawIcon(predPos.x, predPos.y, '#00bcd4', 'PRED', 'circle');
            drawIcon(rawPos.x, rawPos.y, '#4caf50', 'TGT', 'triangle');
        }

        drawObserver();

        // UI Updates
        timeDisplay.textContent = frame.Time.toFixed(3) + 's';
        distDisplay.textContent = frame.Dist.toFixed(2) + ' m';
        velDisplay.textContent = frame.Vel.toFixed(2) + ' m/s';
        yawDisplay.textContent = frame.Yaw.toFixed(2) + '¬∞';
        pitchDisplay.textContent = frame.Pitch.toFixed(2) + '¬∞';
        zoomDisplay.textContent = Math.round(zoom * 100) + '%';
        statusDisplay.textContent = frame.Found ? "TRACKING" : "SEARCHING"; // Update dynamically

        // Horizon
        const maxPitchRange = 45; 
        const yOffset = (frame.Pitch / maxPitchRange) * 50; 
        horizonLine.style.transform = `translateY(${yOffset}px) rotate(${frame.Yaw}deg)`;
    }

    function drawRadarGrid() {
        ctx.strokeStyle = "#222";
        ctx.lineWidth = 1;
        const observerY = height - OBSERVER_Y_OFFSET;
        
        for(let d=10; d<=100; d+=10) {
            ctx.beginPath();
            ctx.arc(width/2, observerY, d * SCALE, Math.PI, 2 * Math.PI); 
            ctx.stroke();
            if (d % 20 === 0) {
                ctx.fillStyle = "#444";
                ctx.font = "10px Arial";
                ctx.fillText(d + "m", width/2 + 5, observerY - (d * SCALE) - 2);
            }
        }
        
        // Center Line
        ctx.beginPath();
        ctx.strokeStyle = "#333";
        ctx.setLineDash([2, 5]);
        ctx.moveTo(width/2, 0);
        ctx.lineTo(width/2, height);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Approx Cone Lines
        ctx.beginPath();
        ctx.moveTo(width/2, observerY);
        ctx.lineTo(width/2 - 300, 0); 
        ctx.moveTo(width/2, observerY);
        ctx.lineTo(width/2 + 300, 0); 
        ctx.stroke();
    }

    function drawFOVCone() {
        const fovHalfRad = Math.atan(320/FOCAL_LENGTH);
        const observerY = height - OBSERVER_Y_OFFSET;
        const maxDrawDist = 600; 

        ctx.fillStyle = "rgba(46, 160, 67, 0.05)";
        ctx.beginPath();
        ctx.moveTo(width/2, observerY);
        ctx.lineTo((width/2) - Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.lineTo((width/2) + Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.closePath();
        ctx.fill();
        
        ctx.strokeStyle = "rgba(46, 160, 67, 0.3)";
        ctx.beginPath();
        ctx.moveTo(width/2, observerY);
        ctx.lineTo((width/2) - Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.moveTo(width/2, observerY);
        ctx.lineTo((width/2) + Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.stroke();
    }

    function drawPath(currentIndex, type, color, lineWidth, isPred = false) {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = lineWidth;
        const start = Math.max(0, currentIndex - 100); 
        let first = true;
        for(let i=start; i <= currentIndex; i++) {
            const f = flightData[i];
            if (!f.Found) continue;

            let pos;
            if (isPred) pos = estimatePredTopDown(f);
            else pos = projectTopDown(f.Dist, f.Yaw);

            if (first) {
                ctx.moveTo(pos.x, pos.y);
                first = false;
            } else {
                ctx.lineTo(pos.x, pos.y);
            }
        }
        ctx.stroke();
    }

    function drawObserver() {
        const x = width / 2;
        const y = height - OBSERVER_Y_OFFSET;
        
        ctx.fillStyle = "#888";
        ctx.beginPath();
        ctx.arc(x, y, 10, Math.PI, 0); 
        ctx.fill();
        ctx.fillRect(x-10, y, 20, 8);
        
        ctx.fillStyle = "#fff";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("CAM", x, y + 25);
    }

    function drawIcon(x, y, color, label, shape) {
        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        
        ctx.beginPath();
        if (shape === 'triangle') {
            const s = 10;
            ctx.moveTo(x, y - s);
            ctx.lineTo(x - s, y + s/1.5);
            ctx.lineTo(x + s, y + s/1.5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (shape === 'circle') {
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(x, y, 2, 0, Math.PI * 2);
            ctx.fill(); 
        }

        ctx.font = "bold 12px Consolas";
        ctx.fillStyle = "white";
        ctx.textAlign = "left";
        ctx.fillText(label, x + 15, y);
    }

    function updateFrame(index) {
        currentIndex = index;
        if (flightData.length === 0) {
            draw();
            return;
        }

        if(currentIndex >= flightData.length) currentIndex = flightData.length - 1;
        if(currentIndex < 0) currentIndex = 0;
        
        timeline.value = currentIndex;
        draw();
    }

    timeline.addEventListener('input', (e) => {
        updateFrame(parseInt(e.target.value));
        if(isPlaying) togglePlay(); 
    });

    function togglePlay() {
        if(flightData.length === 0) {
            log("Cannot play: No data loaded.", 'warn');
            return;
        }

        isPlaying = !isPlaying;
        btnPlay.style.display = isPlaying ? 'none' : 'inline-block';
        btnPause.style.display = isPlaying ? 'inline-block' : 'none';

        if(isPlaying) {
            log("Playback started.");
            playInterval = setInterval(() => {
                if(currentIndex < flightData.length - 1) {
                    updateFrame(currentIndex + 1);
                } else {
                    log("Playback finished.");
                    togglePlay(); 
                }
            }, playbackSpeedMS);
        } else {
            log("Playback paused.");
            clearInterval(playInterval);
        }
    }

    btnPlay.addEventListener('click', togglePlay);
    btnPause.addEventListener('click', togglePlay);

    btnPrev.addEventListener('click', () => {
        if(flightData.length > 0) {
             updateFrame(currentIndex - 1);
        }
    });
    
    btnNext.addEventListener('click', () => {
        if(flightData.length > 0) {
            updateFrame(currentIndex + 1);
        }
    });

    function updateZoom(delta) {
        zoom += delta;
        zoom = Math.max(0.2, Math.min(5.0, zoom));
        draw();
        log(`Zoom level: ${Math.round(zoom*100)}%`);
    }

    btnZoomIn.addEventListener('click', () => updateZoom(0.2));
    btnZoomOut.addEventListener('click', () => updateZoom(-0.2));

    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        updateZoom(delta);
    });

    // Initial Load
    log("System initialized. Waiting to load data...");
    // CSV list already populated on startup; select a file or use the file picker to load.

</script>
</body>
</html>
