<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulazione Double Image Aiming - Top Down</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        header {
            width: 100%;
            padding: 10px 20px;
            background-color: #1e1e1e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
        }

        h1 { margin: 0; font-size: 1.2rem; color: #4caf50; }

        #main-container {
            display: flex;
            flex: 1;
            width: 100%;
            overflow: hidden;
        }

        #canvas-container {
            flex: 3;
            position: relative;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-right: 1px solid #333;
            overflow: hidden;
        }

        canvas {
            background: #0d1117; 
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.05);
            cursor: crosshair;
        }

        #sidebar {
            flex: 1;
            padding: 20px;
            background-color: #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 250px;
            max-width: 350px;
            border-left: 1px solid #333;
        }

        .panel {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .panel h2 {
            margin-top: 0;
            font-size: 0.9rem;
            color: #888;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .data-label { color: #aaa; }
        .data-value { font-weight: bold; }
        .val-green { color: #4caf50; }
        .val-cyan { color: #00bcd4; }
        .val-yellow { color: #ffeb3b; }

        #controls-bar {
            width: 100%;
            background-color: #1e1e1e;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-top: 1px solid #333;
            z-index: 10;
        }

        button {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover { background: #444; border-color: #777; }
        button:active { background: #555; }
        button.active { background: #4caf50; border-color: #4caf50; color: #000; }

        input[type=range] {
            flex: 1;
            accent-color: #4caf50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .icon-tri { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid lime; display: inline-block; }

        /* Artificial Horizon css representation */
        #horizon-container {
            width: 100px;
            height: 100px;
            background: linear-gradient(to bottom, #00BCD4 50%, #795548 50%);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            border: 2px solid #555;
        }
        #horizon-line {
            width: 100%;
            height: 2px;
            background: white;
            position: absolute;
            top: 50%;
            transform-origin: center;
        }
    </style>
</head>
<body>

<header>
    <h1>TOP-DOWN AIMING VISUALIZATION</h1>
    <div style="font-size: 0.8rem; color: #888;">Simulazione v2.0 - Visuale Aerea</div>
</header>

<div id="main-container">
    <div id="canvas-container">
        <canvas id="simCanvas" width="640" height="480"></canvas>
    </div>

    <div id="sidebar">
        <div class="panel">
            <h2>STATO SISTEMA</h2>
            <div class="data-row"><span class="data-label">Tempo:</span> <span id="val-time" class="data-value">0.00s</span></div>
            <div class="data-row"><span class="data-label">Stato:</span> <span id="val-status" class="data-value val-green">TRACKING</span></div>
        </div>

        <div class="panel">
            <h2>TELEMETRIA</h2>
            <div class="data-row"><span class="data-label">Distanza:</span> <span id="val-dist" class="data-value">0.00 m</span></div>
            <div class="data-row"><span class="data-label">Velocità:</span> <span id="val-vel" class="data-value">0.00 m/s</span></div>
            <div class="data-row"><span class="data-label">Yaw:</span> <span id="val-yaw" class="data-value">0.00°</span></div>
            <div class="data-row"><span class="data-label">Pitch:</span> <span id="val-pitch" class="data-value">0.00°</span></div>
        </div>
        
        <div class="panel" style="text-align: center;">
            <h2>ORIENTAMENTO</h2>
            <div id="horizon-container">
                <div id="horizon-line"></div>
            </div>
        </div>

        <div class="panel">
            <h2>LEGENDA (TOP-DOWN)</h2>
            <div class="legend-item"><span class="icon-tri"></span> Posizione Rilevata</div>
            <div class="legend-item"><span class="dot" style="background: cyan; border: 1px solid white;"></span> Posizione Predetta</div>
            <div class="legend-item"><span class="dot" style="background: #888;"></span> Sensore/Camera</div>
            <div class="legend-item"><span style="color: lime;">-----</span> Traiettoria Reale</div>
            <div class="legend-item"><span style="color: cyan;">-----</span> Traiettoria Predetta</div>
        </div>
    </div>
</div>

<div id="controls-bar">
    <button id="btn-play">▶ Play</button>
    <button id="btn-pause" style="display:none;">⏸ Pause</button>
    <button id="btn-prev">⏮ Frame</button>
    <button id="btn-next">Frame ⏭</button>
    
    <span style="font-size: 0.9rem; margin-left:10px;">Timeline:</span>
    <input type="range" id="timeline" min="0" max="100" value="0" step="1">
    
    <span style="font-size: 0.9rem; margin-left:10px;">Zoom:</span>
    <button id="btn-zoom-out">-</button>
    <span id="zoom-level">100%</span>
    <button id="btn-zoom-in">+</button>
</div>

<script>
    // --- DATA INJECTION ---
    const rawCsv = `Time,Dist,Vel,RawX,RawY,PredX,PredY,Yaw,Pitch,Found
0.051,80.00,0.00,320.0,290.0,320.0,290.0,0.00,-0.73,1
0.103,64.00,-308.34,329.5,289.0,329.7,289.2,0.14,-0.95,1
0.155,53.33,-206.69,339.0,289.0,343.6,288.9,0.39,-1.20,1
0.206,45.71,-148.60,349.5,287.0,358.3,286.8,0.72,-1.39,1
0.258,41.03,-91.29,358.5,286.0,370.6,285.1,1.08,-1.57,1
0.309,35.56,-106.71,367.5,283.0,381.5,282.1,1.48,-1.70,1
0.360,32.00,-70.05,376.0,281.0,391.2,279.5,1.89,-1.80,1
0.411,29.63,-46.47,384.0,278.0,400.0,276.3,2.33,-1.87,1
0.462,27.12,-48.73,391.5,274.0,408.1,272.3,2.78,-1.90,1
0.513,25.00,-41.44,398.0,271.0,415.2,268.5,3.23,-1.91,1
0.564,23.53,-28.89,404.0,267.0,421.3,264.3,3.67,-1.88,1
0.615,21.92,-31.44,408.5,262.0,426.3,259.4,4.10,-1.82,1
0.666,20.78,-22.29,412.5,258.0,430.2,254.5,4.52,-1.73,1
0.717,20.00,-15.37,416.0,253.0,433.3,249.3,4.91,-1.61,1
0.768,19.05,-18.73,418.0,248.0,435.2,243.8,5.28,-1.47,1
0.819,18.18,-16.97,419.0,243.0,435.9,238.3,5.61,-1.30,1
0.870,17.58,-11.78,419.5,238.0,435.6,232.7,5.91,-1.10,1
0.921,16.84,-14.57,418.5,233.0,434.0,227.1,6.16,-0.88,1
0.971,16.33,-10.16,417.0,228.0,431.5,221.6,6.37,-0.65,1
1.022,15.69,-12.64,414.0,223.0,427.6,216.1,6.52,-0.40,1
1.073,15.24,-8.83,410.5,219.0,422.9,211.2,6.63,-0.14,1
1.124,14.95,-5.60,405.5,214.0,416.8,206.2,6.67,0.13,1
1.175,14.68,-5.39,400.5,210.0,410.0,201.6,6.67,0.41,1
1.226,14.29,-7.68,394.0,206.0,402.2,197.3,6.61,0.69,1
1.277,14.04,-4.92,387.0,203.0,393.5,193.7,6.48,0.97,1
1.328,13.91,-2.41,379.5,199.0,384.3,190.0,6.31,1.25,1
1.378,13.79,-2.36,371.0,197.0,374.2,187.4,6.07,1.51,1
1.429,13.56,-4.60,362.0,194.0,363.5,184.8,5.78,1.78,1
1.481,13.56,0.00,353.0,192.0,352.4,182.7,5.43,2.03,1
1.532,13.45,-2.23,343.5,191.0,341.1,181.5,5.03,2.26,1
1.583,13.45,0.00,333.5,190.0,329.4,180.8,4.59,2.48,1
1.634,13.33,-2.20,324.0,190.0,318.0,180.9,4.11,2.67,1
1.685,13.33,0.00,314.0,190.0,306.4,181.5,3.59,2.83,1
1.736,13.33,0.00,304.0,190.0,294.9,182.2,3.04,2.98,1
1.787,13.33,0.00,294.0,191.0,283.5,183.6,2.46,3.10,1
1.837,13.45,2.21,284.5,193.0,272.5,185.9,1.85,3.19,1
1.888,13.68,4.53,275.5,195.0,262.1,188.6,1.23,3.25,1
1.939,13.68,0.00,266.5,197.0,252.0,191.6,0.60,3.28,1
1.991,13.91,4.64,258.5,200.0,242.8,195.2,-0.04,3.29,1
2.041,14.16,4.83,250.5,203.0,234.2,199.1,-0.68,3.26,1
2.092,14.41,5.02,243.5,207.0,226.4,203.7,-1.31,3.20,1
2.143,14.68,5.18,237.5,211.0,219.7,208.6,-1.93,3.11,1
2.195,14.95,5.33,232.5,215.0,214.1,213.7,-2.52,2.99,1
2.246,15.38,8.43,228.0,219.0,209.6,218.8,-3.09,2.85,1
2.300,15.84,8.48,224.5,224.0,206.0,224.4,-3.66,2.67,1
2.351,16.33,9.44,222.0,229.0,203.8,230.3,-4.16,2.48,1
2.403,17.02,13.52,220.0,234.0,202.5,236.2,-4.62,2.25,1
2.454,17.58,10.99,219.5,239.0,202.4,242.1,-5.03,2.01,1
2.504,18.18,11.81,220.0,244.0,203.6,247.9,-5.39,1.75,1
2.555,19.05,17.04,221.0,249.0,205.6,253.7,-5.70,1.47,1
2.606,20.00,18.76,224.0,254.0,209.2,259.4,-5.95,1.18,1
2.657,21.05,20.73,227.0,258.0,213.7,264.5,-6.14,0.88,1
2.708,22.22,22.89,231.0,263.0,219.1,269.8,-6.28,0.57,1
2.759,23.88,32.55,236.5,267.0,225.7,274.5,-6.35,0.26,1
2.810,25.40,29.73,242.5,271.0,233.3,278.9,-6.36,-0.05,1
2.861,27.59,43.10,249.0,275.0,241.6,283.2,-6.31,-0.37,1
2.912,30.19,50.78,256.5,278.0,250.7,286.7,-6.20,-0.68,1
2.963,32.65,48.41,264.5,281.0,260.5,289.9,-6.02,-0.98,1
3.014,36.36,72.63,273.0,284.0,270.9,292.8,-5.79,-1.27,1
3.065,41.03,91.91,282.5,286.0,281.9,295.1,-5.50,-1.55,1
3.116,47.06,117.50,292.0,288.0,293.4,297.0,-5.15,-1.82,1
3.167,55.17,159.86,301.5,289.0,304.8,298.0,-4.75,-2.07,1
3.217,66.67,226.70,311.0,289.0,316.3,298.2,-4.31,-2.29,1
3.269,76.19,185.03,321.5,289.0,328.2,297.8,-3.82,-2.49,1
3.320,61.54,-288.44,331.0,289.0,339.6,297.1,-3.31,-2.66,1
3.371,53.33,-160.40,341.0,288.0,351.0,295.7,-2.75,-2.80,1
3.422,44.44,-174.81,351.0,287.0,362.3,293.9,-2.17,-2.92,1
3.473,40.00,-87.28,360.0,285.0,372.9,291.5,-1.57,-3.01,1
3.524,34.78,-101.66,369.0,283.0,383.1,288.7,-0.95,-3.07,1
3.575,31.37,-67.00,377.5,280.0,392.7,285.2,-0.33,-3.10,1
3.626,29.09,-44.38,385.5,277.0,401.6,281.3,0.31,-3.09,1
3.677,27.12,-38.89,392.5,274.0,409.5,277.3,0.92,-3.06,1
3.728,25.00,-41.83,399.0,270.0,416.5,272.6,1.53,-3.00,1
3.778,23.19,-35.67,404.5,266.0,422.5,267.7,2.12,-2.90,1
3.829,21.92,-24.98,409.5,261.0,427.7,262.2,2.69,-2.77,1
3.880,20.78,-22.33,413.5,257.0,431.8,256.8,3.24,-2.62,1
3.931,19.75,-20.23,416.5,252.0,434.7,251.1,3.75,-2.44,1
3.982,18.82,-18.32,418.5,247.0,436.4,245.2,4.22,-2.24,1
4.032,17.98,-16.66,419.5,242.0,437.0,239.3,4.65,-2.01,1
4.084,17.20,-15.03,419.5,237.0,436.4,233.4,5.03,-1.76,1
4.135,16.84,-7.13,418.5,232.0,434.6,227.5,5.36,-1.49,1
4.185,16.16,-13.42,416.5,227.0,431.6,221.8,5.64,-1.21,1
4.236,15.84,-6.30,413.5,223.0,427.5,216.7,5.85,-0.92,1
4.287,15.24,-11.87,409.5,218.0,422.3,211.4,6.01,-0.62,1
4.338,14.81,-8.35,405.0,214.0,416.2,206.7,6.11,-0.31,1
4.388,14.68,-2.68,399.5,209.0,409.2,201.7,6.15,0.00,1
4.439,14.29,-7.73,393.0,206.0,401.2,197.6,6.12,0.31,1
4.490,14.04,-4.92,386.0,202.0,392.5,193.6,6.04,0.62,1
4.541,13.79,-4.77,378.0,199.0,382.9,190.2,5.89,0.93,1
4.591,13.68,-2.33,369.5,196.0,372.6,187.1,5.68,1.22,1
4.642,13.56,-2.28,361.0,194.0,362.1,184.8,5.42,1.51,1
4.693,13.45,-2.24,351.5,192.0,350.9,182.9,5.10,1.78,1
4.744,13.45,0.00,341.5,191.0,339.2,181.7,4.72,2.03,1
4.795,13.33,-2.21,332.0,190.0,327.7,181.1,4.30,2.26,1
4.846,13.33,0.00,322.0,190.0,315.9,181.2,3.84,2.46,1
4.896,13.33,0.00,312.0,190.0,304.3,181.7,3.33,2.64,1
4.948,13.33,0.00,302.0,190.0,292.6,182.4,2.79,2.80,1
4.998,13.45,2.21,292.5,191.0,281.5,183.8,2.22,2.94,1
5.049,13.56,2.25,283.0,193.0,270.7,186.1,1.63,3.04,1
5.100,13.68,2.28,273.5,195.0,260.1,188.8,1.02,3.11,1
5.151,13.79,2.29,265.0,198.0,250.2,192.3,0.39,3.15,1
5.203,14.04,4.74,257.0,200.0,241.1,195.6,-0.23,3.16,1
5.255,14.16,2.37,249.5,204.0,232.7,200.0,-0.88,3.14,1
5.306,14.41,5.01,242.5,207.0,225.2,204.2,-1.49,3.09,1
5.357,14.81,7.88,237.0,211.0,219.0,208.9,-2.09,3.01,1
5.407,15.24,8.33,231.5,216.0,213.4,214.4,-2.66,2.89,1`;

    function parseCSV(csv) {
        const lines = csv.trim().split('\\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const values = lines[i].split(',');
            const entry = {};
            headers.forEach((h, index) => { entry[h] = parseFloat(values[index]); });
            data.push(entry);
        }
        return data;
    }
    const flightData = parseCSV(rawCsv);

    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const width = 640;
    const height = 480;
    
    // UI Elements
    const timeline = document.getElementById('timeline');
    const timeDisplay = document.getElementById('val-time');
    const distDisplay = document.getElementById('val-dist');
    const velDisplay = document.getElementById('val-vel');
    const yawDisplay = document.getElementById('val-yaw');
    const pitchDisplay = document.getElementById('val-pitch');
    const zoomDisplay = document.getElementById('zoom-level');
    const horizonLine = document.getElementById('horizon-line');

    const btnPlay = document.getElementById('btn-play');
    const btnPause = document.getElementById('btn-pause');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');

    let currentIndex = 0;
    let isPlaying = false;
    let playInterval = null;
    let zoom = 1.0;
    const playbackSpeedMS = 50; 

    timeline.max = flightData.length - 1;

    // CONSTANTS FOR TOP-DOWN VIEW
    const FOCAL_LENGTH = 800;
    const CENTER_X = 320;
    const SCALE = 5.0; // Pixels per meter
    const OBSERVER_Y_OFFSET = 50; // Distance from bottom of canvas

    function projectTopDown(dist, yawDeg) {
        const yawRad = yawDeg * (Math.PI / 180);
        const worldX = Math.sin(yawRad) * dist;
        const worldY = Math.cos(yawRad) * dist;

        return {
            x: (width / 2) + (worldX * SCALE),
            y: (height - OBSERVER_Y_OFFSET) - (worldY * SCALE)
        };
    }

    function estimatePredTopDown(frame) {
         // Calculate Yaw from Screen X (simple pinhole model inverse)
         const yawRad = Math.atan((frame.PredX - CENTER_X) / FOCAL_LENGTH);
         const yawDeg = yawRad * (180 / Math.PI);
         
         // Predict distance: Current Dist + (Velocity * dt)
         const dt = 0.051; 
         // Velocity negative means approaching
         const predDist = Math.max(0, frame.Dist + (frame.Vel * dt));
         
         return projectTopDown(predDist, yawDeg);
    }

    function draw() {
        // Clear Background
        ctx.setTransform(1, 0, 0, 1, 0, 0); 
        ctx.fillStyle = "#0d1117"; 
        ctx.fillRect(0, 0, width, height);
        
        ctx.setTransform(zoom, 0, 0, zoom, (width - width * zoom) / 2, (height - height * zoom) / 2);

        drawRadarGrid();
        const frame = flightData[currentIndex];

        // 1. Draw FOV Cone
        drawFOVCone();

        // 2. Draw Trails
        if (currentIndex > 0) {
            drawPath(currentIndex, 'Raw', "#4caf50", 2); 
            drawPath(currentIndex, 'Pred', "#00bcd4", 2, true); 
        }

        // 3. Draw Objects
        if (frame.Found) {
            const rawPos = projectTopDown(frame.Dist, frame.Yaw);
            const predPos = estimatePredTopDown(frame);

            // Connection line
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 0, 0.4)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.moveTo(rawPos.x, rawPos.y);
            ctx.lineTo(predPos.x, predPos.y);
            ctx.stroke();
            ctx.setLineDash([]);

            drawIcon(predPos.x, predPos.y, '#00bcd4', 'PRED', 'circle');
            drawIcon(rawPos.x, rawPos.y, '#4caf50', 'TGT', 'triangle');
        }

        // 4. Draw Observer
        drawObserver();

        // --- UPDATE UI TEXT ---
        timeDisplay.textContent = frame.Time.toFixed(3) + 's';
        distDisplay.textContent = frame.Dist.toFixed(2) + ' m';
        velDisplay.textContent = frame.Vel.toFixed(2) + ' m/s';
        yawDisplay.textContent = frame.Yaw.toFixed(2) + '°';
        pitchDisplay.textContent = frame.Pitch.toFixed(2) + '°';
        zoomDisplay.textContent = Math.round(zoom * 100) + '%';

        // Horizon Update
        const maxPitchRange = 45; 
        const yOffset = (frame.Pitch / maxPitchRange) * 50; 
        horizonLine.style.transform = `translateY(${yOffset}px) rotate(${frame.Yaw}deg)`;
    }

    function drawRadarGrid() {
        ctx.strokeStyle = "#222";
        ctx.lineWidth = 1;
        const observerY = height - OBSERVER_Y_OFFSET;
        
        for(let d=10; d<=100; d+=10) {
            ctx.beginPath();
            ctx.arc(width/2, observerY, d * SCALE, Math.PI, 2 * Math.PI); 
            ctx.stroke();
            
            if (d % 20 === 0) {
                ctx.fillStyle = "#444";
                ctx.font = "10px Arial";
                ctx.fillText(d + "m", width/2 + 5, observerY - (d * SCALE) - 2);
            }
        }
        
        ctx.beginPath();
        ctx.moveTo(width/2, 0);
        ctx.lineTo(width/2, height);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(width/2, observerY);
        ctx.lineTo(width/2 - 300, 0); // Approx 30 deg left
        ctx.moveTo(width/2, observerY);
        ctx.lineTo(width/2 + 300, 0); // Approx 30 deg right
        ctx.stroke();
    }

    function drawFOVCone() {
        // Half FOV ~22 deg (atan 320/800)
        const fovHalfRad = Math.atan(320/800);
        const observerY = height - OBSERVER_Y_OFFSET;
        const maxDrawDist = 600; 

        ctx.fillStyle = "rgba(46, 160, 67, 0.05)";
        ctx.beginPath();
        ctx.moveTo(width/2, observerY);
        ctx.lineTo((width/2) - Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.lineTo((width/2) + Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.closePath();
        ctx.fill();
        
        ctx.strokeStyle = "rgba(46, 160, 67, 0.2)";
        ctx.beginPath();
        ctx.moveTo(width/2, observerY);
        ctx.lineTo((width/2) - Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.moveTo(width/2, observerY);
        ctx.lineTo((width/2) + Math.tan(fovHalfRad)*maxDrawDist, observerY - maxDrawDist);
        ctx.stroke();
    }

    function drawPath(currentIndex, type, color, lineWidth, isPred = false) {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = lineWidth;
        const start = Math.max(0, currentIndex - 100); 
        let first = true;
        for(let i=start; i <= currentIndex; i++) {
            const f = flightData[i];
            if (!f.Found) continue;

            let pos;
            if (isPred) pos = estimatePredTopDown(f);
            else pos = projectTopDown(f.Dist, f.Yaw);

            if (first) {
                ctx.moveTo(pos.x, pos.y);
                first = false;
            } else {
                ctx.lineTo(pos.x, pos.y);
            }
        }
        ctx.stroke();
    }

    function drawObserver() {
        const x = width / 2;
        const y = height - OBSERVER_Y_OFFSET;
        
        ctx.fillStyle = "#888";
        ctx.beginPath();
        ctx.arc(x, y, 10, Math.PI, 0); 
        ctx.fill();
        ctx.fillRect(x-10, y, 20, 8);
        
        ctx.fillStyle = "#fff";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("CAM", x, y + 25);
    }

    function drawIcon(x, y, color, label, shape) {
        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        
        if (shape === 'triangle') {
            const s = 10;
            ctx.beginPath();
            ctx.moveTo(x, y - s);
            ctx.lineTo(x - s, y + s/1.5);
            ctx.lineTo(x + s, y + s/1.5);
            ctx.closePath();
            ctx.fill();
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.stroke();
            ctx.shadowBlur = 0;
            
        } else if (shape === 'circle') {
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.arc(x, y, 2, 0, Math.PI * 2);
            ctx.fill(); 
        }

        ctx.font = "bold 12px Consolas";
        ctx.fillStyle = "white";
        ctx.textAlign = "left";
        ctx.fillText(label, x + 15, y);
    }

    function updateFrame(index) {
        currentIndex = index;
        if(currentIndex >= flightData.length) currentIndex = flightData.length - 1;
        if(currentIndex < 0) currentIndex = 0;
        
        timeline.value = currentIndex;
        draw();
    }

    timeline.addEventListener('input', (e) => {
        updateFrame(parseInt(e.target.value));
        if(isPlaying) togglePlay(); 
    });

    function togglePlay() {
        isPlaying = !isPlaying;
        btnPlay.style.display = isPlaying ? 'none' : 'inline-block';
        btnPause.style.display = isPlaying ? 'inline-block' : 'none';

        if(isPlaying) {
            playInterval = setInterval(() => {
                if(currentIndex < flightData.length - 1) {
                    updateFrame(currentIndex + 1);
                } else {
                    togglePlay(); 
                }
            }, playbackSpeedMS);
        } else {
            clearInterval(playInterval);
        }
    }

    btnPlay.addEventListener('click', togglePlay);
    btnPause.addEventListener('click', togglePlay);

    btnPrev.addEventListener('click', () => {
        updateFrame(currentIndex - 1);
        if(isPlaying) togglePlay(); 
    });
    
    btnNext.addEventListener('click', () => {
        updateFrame(currentIndex + 1);
        if(isPlaying) togglePlay(); 
    });

    function updateZoom(delta) {
        zoom += delta;
        zoom = Math.max(0.2, Math.min(5.0, zoom));
        draw();
    }

    btnZoomIn.addEventListener('click', () => updateZoom(0.2));
    btnZoomOut.addEventListener('click', () => updateZoom(-0.2));

    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        updateZoom(delta);
    });

    updateFrame(0);

</script>
</body>
</html>
